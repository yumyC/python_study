# Docker Compose 配置示例
# 用于本地开发和测试环境

version: '3.8'

# ============================================================================
# 服务定义
# ============================================================================

services:
  # Web 应用服务
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: myapp-web
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - DEBUG=true
    volumes:
      # 开发时挂载代码目录（热重载）
      - ./app:/app
      # 持久化日志
      - ./logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # PostgreSQL 数据库
  db:
    image: postgres:14-alpine
    container_name: myapp-db
    environment:
      - POSTGRES_DB=myapp
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      # 持久化数据
      - postgres_data:/var/lib/postgresql/data
      # 初始化脚本
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: myapp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Celery Worker（异步任务）
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: myapp-celery-worker
    command: celery -A myapp worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./app:/app
    depends_on:
      - db
      - redis
    networks:
      - app-network
    restart: unless-stopped

  # Celery Beat（定时任务）
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: myapp-celery-beat
    command: celery -A myapp beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./app:/app
    depends_on:
      - db
      - redis
    networks:
      - app-network
    restart: unless-stopped

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: myapp-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/usr/share/nginx/html/static:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
    networks:
      - app-network
    restart: unless-stopped

# ============================================================================
# 网络定义
# ============================================================================

networks:
  app-network:
    driver: bridge

# ============================================================================
# 卷定义
# ============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

# ============================================================================
# 使用说明
# ============================================================================

# 启动所有服务：
#   docker-compose up -d

# 启动特定服务：
#   docker-compose up -d web db

# 查看日志：
#   docker-compose logs -f
#   docker-compose logs -f web

# 停止所有服务：
#   docker-compose down

# 停止并删除卷：
#   docker-compose down -v

# 重启服务：
#   docker-compose restart web

# 执行命令：
#   docker-compose exec web python manage.py migrate
#   docker-compose exec db psql -U postgres -d myapp

# 查看服务状态：
#   docker-compose ps

# 构建镜像：
#   docker-compose build

# 拉取镜像：
#   docker-compose pull

# ============================================================================
# 环境变量
# ============================================================================

# 创建 .env 文件来覆盖默认值：
#
# SECRET_KEY=your-secret-key
# DATABASE_URL=postgresql://user:pass@db:5432/myapp
# REDIS_URL=redis://redis:6379/0
# DEBUG=false

# ============================================================================
# 生产环境配置
# ============================================================================

# 对于生产环境，创建 docker-compose.prod.yml：
#
# version: '3.8'
# services:
#   web:
#     build:
#       context: .
#       dockerfile: Dockerfile
#     environment:
#       - DEBUG=false
#     # 移除卷挂载
#     # 使用环境变量而不是硬编码
#
# 使用：
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# ============================================================================
# 开发环境配置
# ============================================================================

# 对于开发环境，创建 docker-compose.dev.yml：
#
# version: '3.8'
# services:
#   web:
#     build:
#       dockerfile: Dockerfile.dev
#     command: python app.py --reload
#     volumes:
#       - ./app:/app
#     environment:
#       - DEBUG=true
#
# 使用：
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# ============================================================================
# 扩展服务
# ============================================================================

# 扩展 web 服务到 3 个实例：
#   docker-compose up -d --scale web=3

# 注意：需要移除 container_name 和使用负载均衡器

# ============================================================================
# 常见问题
# ============================================================================

# Q: 如何查看容器 IP？
# A: docker-compose exec web hostname -i

# Q: 如何重新构建镜像？
# A: docker-compose build --no-cache

# Q: 如何清理未使用的资源？
# A: docker system prune -a

# Q: 如何备份数据库？
# A: docker-compose exec db pg_dump -U postgres myapp > backup.sql

# Q: 如何恢复数据库？
# A: docker-compose exec -T db psql -U postgres myapp < backup.sql
