name: Frontend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend_ci.yml'

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/pure-admin-thin/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend/pure-admin-thin
      run: npm ci
    
    - name: Run code quality checks
      working-directory: frontend/pure-admin-thin
      run: |
        # ESLint 代码检查
        npm run lint
        # Prettier 格式检查
        npm run format -- --check
    
    - name: Type checking
      working-directory: frontend/pure-admin-thin
      run: |
        # TypeScript 类型检查
        npx vue-tsc --noEmit
    
    - name: Run unit tests
      working-directory: frontend/pure-admin-thin
      run: |
        # 如果有测试，运行测试
        # npm run test:unit
        echo "Unit tests would run here"
    
    - name: Build application
      working-directory: frontend/pure-admin-thin
      run: |
        npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-dist-${{ matrix.node-version }}
        path: frontend/pure-admin-thin/dist/
        retention-days: 7

  lighthouse-audit:
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        cache-dependency-path: frontend/pure-admin-thin/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend/pure-admin-thin
      run: npm ci
    
    - name: Build application
      working-directory: frontend/pure-admin-thin
      run: npm run build
    
    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
    
    - name: Run Lighthouse CI
      working-directory: frontend/pure-admin-thin
      run: |
        # 启动静态服务器并运行 Lighthouse 审计
        npx serve -s dist -l 3000 &
        sleep 5
        lhci autorun --upload.target=temporary-public-storage --collect.staticDistDir=dist
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        cache-dependency-path: frontend/pure-admin-thin/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend/pure-admin-thin
      run: npm ci
    
    - name: Run security audit
      working-directory: frontend/pure-admin-thin
      run: |
        # npm 安全审计
        npm audit --audit-level=moderate
        # 生成安全报告
        npm audit --json > security-audit.json || true
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: frontend-security-report
        path: frontend/pure-admin-thin/security-audit.json

  build-docker:
    runs-on: ubuntu-latest
    needs: [test-and-build, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        cache-dependency-path: frontend/pure-admin-thin/package-lock.json
    
    - name: Install dependencies and build
      working-directory: frontend/pure-admin-thin
      run: |
        npm ci
        npm run build
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Create Dockerfile for frontend
      working-directory: frontend/pure-admin-thin
      run: |
        cat > Dockerfile << 'EOF'
        # 多阶段构建 - 构建阶段
        FROM node:20-alpine AS builder
        
        WORKDIR /app
        
        # 复制 package 文件
        COPY package*.json ./
        
        # 安装依赖
        RUN npm ci --only=production
        
        # 复制源代码
        COPY . .
        
        # 构建应用
        RUN npm run build
        
        # 生产阶段 - Nginx
        FROM nginx:alpine
        
        # 复制构建产物到 Nginx 目录
        COPY --from=builder /app/dist /usr/share/nginx/html
        
        # 复制 Nginx 配置
        COPY nginx.conf /etc/nginx/conf.d/default.conf
        
        # 暴露端口
        EXPOSE 80
        
        # 启动 Nginx
        CMD ["nginx", "-g", "daemon off;"]
        EOF
    
    - name: Create Nginx configuration
      working-directory: frontend/pure-admin-thin
      run: |
        cat > nginx.conf << 'EOF'
        server {
            listen 80;
            server_name localhost;
            root /usr/share/nginx/html;
            index index.html;
            
            # 启用 gzip 压缩
            gzip on;
            gzip_vary on;
            gzip_min_length 1024;
            gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
            
            # 处理 Vue Router 的 history 模式
            location / {
                try_files $uri $uri/ /index.html;
            }
            
            # 静态资源缓存
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            # API 代理（如果需要）
            location /api/ {
                proxy_pass http://backend:8000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        EOF
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: frontend/pure-admin-thin
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/crm-frontend:latest
          ${{ secrets.DOCKER_USERNAME }}/crm-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max