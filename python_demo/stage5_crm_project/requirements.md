# CRM 项目需求文档

## 项目概述

本项目是一个企业级的客户关系管理（CRM）系统，主要用于管理企业内部的员工、岗位、角色、权限和工作日志。系统采用前后端分离架构，后端提供 RESTful API，前端使用现代化的管理后台框架。

## 业务背景

企业需要一个统一的平台来管理员工信息、组织架构、权限分配和日常工作记录。系统应该支持：

- 灵活的组织架构管理（岗位层级）
- 细粒度的权限控制（基于角色和菜单）
- 员工日常工作的记录和评估
- 数据的导出和分析

## 功能需求

### 1. 用户认证与授权

#### 1.1 用户登录

**功能描述**: 员工使用用户名和密码登录系统

**输入**:
- 用户名（必填）
- 密码（必填）

**输出**:
- 成功: 返回 JWT Access Token 和 Refresh Token
- 失败: 返回错误信息（用户名或密码错误）

**业务规则**:
- 密码错误 5 次后锁定账户 30 分钟
- Access Token 有效期 2 小时
- Refresh Token 有效期 7 天

#### 1.2 Token 刷新

**功能描述**: 使用 Refresh Token 获取新的 Access Token

**输入**:
- Refresh Token

**输出**:
- 成功: 返回新的 Access Token
- 失败: 返回错误信息（Token 无效或过期）

#### 1.3 获取当前用户信息

**功能描述**: 获取当前登录用户的详细信息

**输入**:
- Access Token（请求头）

**输出**:
- 用户基本信息
- 所属岗位
- 角色信息
- 权限列表

#### 1.4 权限验证

**功能描述**: 验证用户是否有权限访问特定资源

**验证方式**:
- 基于角色的访问控制（RBAC）
- 菜单级别的权限控制
- 操作级别的权限控制（查看、创建、更新、删除）

### 2. 员工管理

#### 2.1 创建员工

**功能描述**: 添加新员工到系统

**输入**:
- 用户名（必填，唯一）
- 邮箱（必填，唯一）
- 密码（必填，至少 8 位）
- 姓名（必填）
- 岗位 ID（必填）
- 角色 ID（必填）
- 状态（可选，默认为激活）

**输出**:
- 成功: 返回创建的员工信息
- 失败: 返回验证错误信息

**业务规则**:
- 用户名只能包含字母、数字和下划线
- 邮箱格式必须正确
- 密码必须包含大小写字母和数字
- 默认密码需要首次登录后修改

#### 2.2 查询员工列表

**功能描述**: 分页查询员工列表，支持搜索和筛选

**输入**:
- 页码（可选，默认 1）
- 每页数量（可选，默认 20）
- 搜索关键词（可选，搜索用户名、姓名、邮箱）
- 岗位 ID（可选）
- 角色 ID（可选）
- 状态（可选）

**输出**:
- 员工列表
- 总记录数
- 当前页码
- 总页数

#### 2.3 查询员工详情

**功能描述**: 根据 ID 查询员工详细信息

**输入**:
- 员工 ID

**输出**:
- 员工完整信息
- 关联的岗位信息
- 关联的角色信息

#### 2.4 更新员工信息

**功能描述**: 更新员工的基本信息

**输入**:
- 员工 ID
- 要更新的字段（邮箱、姓名、岗位、角色、状态等）

**输出**:
- 成功: 返回更新后的员工信息
- 失败: 返回验证错误信息

**业务规则**:
- 不能修改用户名
- 修改邮箱需要验证唯一性
- 修改密码需要单独的接口

#### 2.5 删除员工

**功能描述**: 删除员工（软删除）

**输入**:
- 员工 ID

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 采用软删除，不真正删除数据
- 删除后的员工不能登录
- 保留历史数据用于审计

#### 2.6 修改密码

**功能描述**: 员工修改自己的密码

**输入**:
- 旧密码
- 新密码
- 确认新密码

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 必须验证旧密码
- 新密码不能与旧密码相同
- 新密码必须符合密码策略

### 3. 岗位管理

#### 3.1 创建岗位

**功能描述**: 创建新的岗位

**输入**:
- 岗位名称（必填）
- 岗位编码（必填，唯一）
- 岗位描述（可选）
- 岗位层级（必填）
- 上级岗位 ID（可选）

**输出**:
- 成功: 返回创建的岗位信息
- 失败: 返回验证错误信息

**业务规则**:
- 岗位编码必须唯一
- 岗位层级从 1 开始
- 上级岗位的层级必须小于当前岗位

#### 3.2 查询岗位列表

**功能描述**: 查询所有岗位，支持树形结构展示

**输入**:
- 是否返回树形结构（可选）

**输出**:
- 岗位列表（平铺或树形）

#### 3.3 查询岗位详情

**功能描述**: 根据 ID 查询岗位详细信息

**输入**:
- 岗位 ID

**输出**:
- 岗位完整信息
- 上级岗位信息
- 下级岗位列表

#### 3.4 更新岗位信息

**功能描述**: 更新岗位信息

**输入**:
- 岗位 ID
- 要更新的字段

**输出**:
- 成功: 返回更新后的岗位信息
- 失败: 返回验证错误信息

#### 3.5 删除岗位

**功能描述**: 删除岗位

**输入**:
- 岗位 ID

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 有员工的岗位不能删除
- 有下级岗位的岗位不能删除

### 4. 菜单管理

#### 4.1 创建菜单

**功能描述**: 创建新的菜单项

**输入**:
- 菜单名称（必填）
- 菜单路径（必填）
- 菜单图标（可选）
- 组件路径（必填）
- 上级菜单 ID（可选）
- 排序号（可选）
- 是否可见（可选，默认可见）

**输出**:
- 成功: 返回创建的菜单信息
- 失败: 返回验证错误信息

#### 4.2 查询菜单列表

**功能描述**: 查询所有菜单，返回树形结构

**输入**:
- 无

**输出**:
- 菜单树形结构

#### 4.3 查询用户菜单

**功能描述**: 根据用户角色查询有权限的菜单

**输入**:
- 用户 ID 或从 Token 获取

**输出**:
- 用户有权限的菜单树

#### 4.4 更新菜单信息

**功能描述**: 更新菜单信息

**输入**:
- 菜单 ID
- 要更新的字段

**输出**:
- 成功: 返回更新后的菜单信息
- 失败: 返回验证错误信息

#### 4.5 删除菜单

**功能描述**: 删除菜单

**输入**:
- 菜单 ID

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 有下级菜单的菜单不能删除
- 删除菜单会同时删除相关的权限绑定

### 5. 角色管理

#### 5.1 创建角色

**功能描述**: 创建新的角色

**输入**:
- 角色名称（必填）
- 角色编码（必填，唯一）
- 角色描述（可选）

**输出**:
- 成功: 返回创建的角色信息
- 失败: 返回验证错误信息

#### 5.2 查询角色列表

**功能描述**: 查询所有角色

**输入**:
- 页码（可选）
- 每页数量（可选）

**输出**:
- 角色列表

#### 5.3 查询角色详情

**功能描述**: 根据 ID 查询角色详细信息

**输入**:
- 角色 ID

**输出**:
- 角色完整信息
- 关联的权限列表

#### 5.4 更新角色信息

**功能描述**: 更新角色信息

**输入**:
- 角色 ID
- 要更新的字段

**输出**:
- 成功: 返回更新后的角色信息
- 失败: 返回验证错误信息

#### 5.5 删除角色

**功能描述**: 删除角色

**输入**:
- 角色 ID

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 有员工使用的角色不能删除
- 删除角色会同时删除相关的权限绑定

### 6. 权限管理

#### 6.1 分配角色权限

**功能描述**: 为角色分配菜单权限

**输入**:
- 角色 ID
- 菜单权限列表
  - 菜单 ID
  - 权限类型（view, create, update, delete）

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 一次性替换角色的所有权限
- 权限立即生效

#### 6.2 查询角色权限

**功能描述**: 查询角色拥有的所有权限

**输入**:
- 角色 ID

**输出**:
- 权限列表（菜单 + 操作类型）

#### 6.3 检查用户权限

**功能描述**: 检查用户是否有特定权限

**输入**:
- 用户 ID
- 菜单路径
- 操作类型

**输出**:
- 是否有权限（布尔值）

### 7. 工作日志管理

#### 7.1 创建工作日志

**功能描述**: 员工创建当天的工作日志

**输入**:
- 日志日期（必填，默认当天）
- 工作内容（必填）
- 完成情况（必填：已完成、进行中、待处理）
- 遇到的问题（可选）
- 明日计划（可选）
- 自评分数（可选，1-5 分）

**输出**:
- 成功: 返回创建的日志信息
- 失败: 返回验证错误信息

**业务规则**:
- 每个员工每天只能创建一条日志
- 只能创建当天的日志
- 创建后可以修改

#### 7.2 查询工作日志列表

**功能描述**: 查询工作日志，支持筛选和分页

**输入**:
- 页码（可选）
- 每页数量（可选）
- 员工 ID（可选）
- 开始日期（可选）
- 结束日期（可选）
- 完成情况（可选）

**输出**:
- 日志列表
- 总记录数
- 分页信息

**权限规则**:
- 员工只能查看自己的日志
- 主管可以查看下属的日志
- 管理员可以查看所有日志

#### 7.3 查询工作日志详情

**功能描述**: 根据 ID 查询日志详细信息

**输入**:
- 日志 ID

**输出**:
- 日志完整信息
- 员工信息
- 评分信息

#### 7.4 更新工作日志

**功能描述**: 更新工作日志内容

**输入**:
- 日志 ID
- 要更新的字段

**输出**:
- 成功: 返回更新后的日志信息
- 失败: 返回验证错误信息

**业务规则**:
- 只能更新当天的日志
- 已被上级评分的日志不能修改工作内容

#### 7.5 上级评分

**功能描述**: 上级对下属的工作日志进行评分

**输入**:
- 日志 ID
- 上级评分（必填，1-5 分）
- 上级评语（可选）

**输出**:
- 成功: 返回更新后的日志信息
- 失败: 返回错误信息

**业务规则**:
- 只有上级可以评分
- 评分后可以修改
- 评分会通知员工

#### 7.6 删除工作日志

**功能描述**: 删除工作日志

**输入**:
- 日志 ID

**输出**:
- 成功: 返回成功消息
- 失败: 返回错误信息

**业务规则**:
- 只能删除自己的日志
- 只能删除当天的日志
- 已评分的日志不能删除

#### 7.7 导出工作日志

**功能描述**: 导出工作日志为 Excel 文件

**输入**:
- 员工 ID（可选）
- 开始日期（必填）
- 结束日期（必填）
- 导出格式（默认 Excel）

**输出**:
- 成功: 返回任务 ID
- 失败: 返回错误信息

**业务规则**:
- 使用异步任务处理导出
- 导出完成后生成下载链接
- 下载链接 24 小时有效

#### 7.8 查询导出任务状态

**功能描述**: 查询导出任务的执行状态

**输入**:
- 任务 ID

**输出**:
- 任务状态（pending, processing, completed, failed）
- 进度百分比
- 下载链接（如果完成）
- 错误信息（如果失败）

#### 7.9 下载导出文件

**功能描述**: 下载已完成的导出文件

**输入**:
- 任务 ID 或文件 ID

**输出**:
- Excel 文件流

**业务规则**:
- 验证用户权限
- 验证链接有效期
- 记录下载日志

## 非功能需求

### 1. 性能要求

- API 响应时间: 95% 的请求在 200ms 内响应
- 并发用户: 支持 100 个并发用户
- 数据库查询: 单次查询不超过 100ms
- 导出任务: 10000 条记录在 30 秒内完成

### 2. 安全要求

- 密码加密: 使用 bcrypt 加密存储
- Token 安全: JWT Token 包含过期时间和签名
- SQL 注入防护: 使用 ORM 参数化查询
- XSS 防护: 前端输入验证和转义
- CORS 配置: 限制允许的来源域名
- 敏感信息: 不在日志中记录密码等敏感信息

### 3. 可用性要求

- 系统可用性: 99% 以上
- 错误恢复: 自动重试机制
- 数据备份: 每天自动备份数据库
- 日志保留: 保留 30 天的操作日志

### 4. 可维护性要求

- 代码规范: 遵循 PEP 8 规范
- 代码注释: 关键逻辑必须有注释
- API 文档: 自动生成的交互式文档
- 测试覆盖率: 核心业务逻辑 80% 以上

### 5. 可扩展性要求

- 模块化设计: 各模块低耦合
- 配置外部化: 使用环境变量或配置文件
- 数据库迁移: 使用 Alembic 管理数据库版本
- 容器化部署: 支持 Docker 部署

## 数据字典

详见 [数据库设计文档](docs/database_schema.md)

## API 接口规范

详见 [API 文档](docs/api_documentation.md)

## 用户角色

### 1. 普通员工
- 查看自己的信息
- 修改自己的密码
- 创建和管理自己的工作日志
- 查看自己有权限的菜单

### 2. 部门主管
- 普通员工的所有权限
- 查看和评分下属的工作日志
- 查看部门员工信息

### 3. HR 管理员
- 管理所有员工信息
- 管理岗位信息
- 查看所有工作日志

### 4. 系统管理员
- 所有权限
- 管理角色和权限
- 管理菜单
- 系统配置

## 业务流程

### 1. 员工入职流程

1. HR 创建员工账号
2. 分配岗位和角色
3. 系统发送初始密码（邮件或短信）
4. 员工首次登录修改密码
5. 员工可以正常使用系统

### 2. 权限分配流程

1. 系统管理员创建角色
2. 为角色分配菜单权限
3. HR 为员工分配角色
4. 员工登录后看到对应的菜单
5. 访问功能时验证权限

### 3. 工作日志流程

1. 员工每天下班前填写工作日志
2. 记录当天工作内容和完成情况
3. 进行自我评分
4. 上级查看并评分
5. 月底导出日志进行绩效评估

## 约束和限制

1. **技术约束**
   - Python 3.9+
   - PostgreSQL 13+ 或 MySQL 8+
   - Redis 6+

2. **业务约束**
   - 用户名和邮箱必须唯一
   - 每个员工必须有岗位和角色
   - 工作日志每天只能创建一条

3. **数据约束**
   - 文本字段最大长度 1000 字符
   - 导出文件最大 10000 条记录
   - 文件保留时间 24 小时

## 未来扩展

1. **第一期**（当前）
   - 基础的员工、岗位、角色、权限管理
   - 工作日志功能

2. **第二期**（规划中）
   - 客户管理
   - 销售机会管理
   - 销售漏斗分析

3. **第三期**（规划中）
   - 移动端 App
   - 消息通知
   - 数据分析看板

## 参考资料

- [RESTful API 设计指南](https://restfulapi.net/)
- [JWT 最佳实践](https://tools.ietf.org/html/rfc8725)
- [RBAC 权限模型](https://en.wikipedia.org/wiki/Role-based_access_control)
